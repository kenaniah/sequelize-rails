#!/usr/bin/env zsh

# This script sets up the development environment for this project from the ground up.
# This script is idempotent, so it can be run multiple times without harm.

# Error reporting
set -e
trap "echo -e \"\\033[91mError occurred during setup on line $LINENO. \\033[0m\"" ERR

# Ensure we're in the top directory
cd ${0:a:h}/..

# Install homebrew if not already installed
if ! [ -x "$(command -v brew)" ]; then
  echo "Installing homebrew..."
  zsh -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Install homebrew packages
brew install -q git mkcert nss nginx rbenv ruby-build

# Issue a local TLS certificate
mkcert --install
if [ ! -f dev/localhost.pem ]; then
  mkcert --cert-file=dev/localhost.pem --key-file=dev/localhost-key.pem localhost 127.0.0.1
fi

# Install the proper version of Ruby
rbenv install --skip-existing
gem install bundler --conservative

# Install the rails dependencies
bundle install

# bin/rails db:prepare log:clear tmp:clear
# bin/rails restart
